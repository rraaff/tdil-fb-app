<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>jQuery UI Droppable - SVG</title>
<link rel="stylesheet" href="./themes/base/jquery.ui.all.css">
<script src="./js/jquery-1.7.1.min.js"></script>
<script src="./js/jquery-ui-1.8.18.custom.min.js"></script>
<script type="text/javascript" src="./js/jquery.svg.js"></script>
<script type="text/javascript" src="./js/jquery.svgdom.js"></script>
<script type="text/javascript" src="./js/jquery.svganim.js"></script>
<script type="text/javascript" src="./js/jquery.cookie.js"></script>

<link rel="stylesheet" href="./themes/demos.css">
<style>
#gallery {
	float: left;
	width: 400px;
	min-height: 12em;
}

* html #gallery {
	height: 12em;
} /* IE6 */
.gallery.custom-state-active {
	background: #eee;
}

.gallery div {
	float: left;
	width: 96px;
	padding: 0.4em;
	margin: 0 0.4em 0.4em 0;
	text-align: center;
}

.gallery div h5 {
	margin: 0 0 0.4em;
	cursor: move;
}

.gallery div a {
	float: right;
}

.gallery div a.ui-icon-zoomin {
	
}

.gallery div img {
	width: 100%;
	cursor: move;
}

#trash {
	float: bottom;
	width: 400px;
	min-height: 10em;
	padding: 1%;
}

* html #trash {
	height: 10em;
} /* IE6 */
#trash h4 {
	line-height: 16px;
	margin: 0 0 0.4em;
}

#trash h4 .ui-icon {
}

#trash .gallery .svgcanvas {
	display: none;
}
</style>
<script>

	// Variables que pueden ser editadas
	// Ancho destino de las miniaturas
	var svgThumbWidth = 100;
	// Alto destino de las miniaturas
	var svgThumbHeigth = 63;
	// Duracion de la cookie (dias)
	var setCookieExpiry = 7;
	// Fin variables
	
	var setSelector = "#gallery";
	var setCookieName = "galleryOrder";
	var restoring = false;
	
	// Funcion que salva el estado de la galeria en la cookie
	function saveOrder() {
		if (restoring) {return;	}
		$.cookie(setCookieName, $(setSelector).sortable("toArray"), { expires: setCookieExpiry, path: "/" });
	}
	
	$(function() {	
		// Galeria y trash
		var $gallery = $("#gallery"), $trash = $("#trash");
		$gallery.sortable({update: function() { saveOrder(); }});

		// Funcion que restaura los items de la galeria de la cookie
		function restoreOrder() {
			restoring = true;
			var list = $(setSelector);
			if (list == null) return;
			// fetch the cookie value (saved order)
			var cookie = $.cookie(setCookieName);
			if (!cookie) return;
			// make array from saved order
			var IDs = cookie.split(",");
			// fetch current order
			var items = list.sortable("toArray");
			// make array from current order
			var rebuild = new Array();
			for ( var v=0, len=items.length; v<len; v++) {
				rebuild[items[v]] = items[v];
			}
			for (var i = 0, n = items.length; i < n; i++) {
				// item id from saved order
				var itemID = items[i];
				deleteImage($("#" + itemID));
			}
			for (var i = 0, n = IDs.length; i < n; i++) {
				// item id from saved order
				var itemID = IDs[i];
				recycleImage($("#" + itemID));
			}
			restoring = false;
		}
		
		// Funcion que quita un svg de la galeria
		function deleteImage($item) {
			if (!$item.attr('closed') || $item.attr('closed') == '0') {
				var $list = $("div", $trash).length ? $("div", $trash)[0] : $(
						"<div class='gallery ui-helper-reset'/>").appendTo($trash);
				$item.appendTo($list);
				$item.attr('closed', '1');
				saveOrder();
			}
		}

		// Funcion que vuelve un svg a la galeria
		function recycleImage($item) {
			$item.appendTo($gallery);
			$item.attr('closed', '0');
			saveOrder();
		}

		// Imagen que muestra un svg en su tamaño original
		// Si esta minimizado, lo vuelve a la lista de visibles
		function viewLargerImage($item, $link) {
			if (!$item.attr('closed') || $item.attr('closed') == '0') {
				$('#dialogDiv').svg();
				var svg = $("#dialogDiv").svg('get');
				svg.load($link.attr("href"), {
					addTo : true,
					changeSize : true
				});
				$('#dialogContainer').dialog("option" , "title" , $link.attr("title"));
				$("#dialogContainer").dialog("open");
				return;
			} else {
				recycleImage($item);
			}
		}

		// Funcion que maneja el onlick de los iconos
		$("div.gallery > div").click(function(event) {
			var $item = $(this), $target = $(event.target);
			if ($target.is("a.ui-icon-trash")) {
				deleteImage($item);
			} else if ($target.is("a.ui-icon-zoomin")) {
				// si esta normal, agrando, si esta min, vuelvo al panel
				viewLargerImage($item, $target);
			} else if ($target.is("a.ui-icon-refresh")) {
				recycleImage($item);
			}
			return false;
		});

		restoring = true;
		
		// seccion de carga de los svgs
		loadSVG($("#canvas00"), './svg/gfloppy.svg');
		loadSVG($("#canvas01"), './svg/antenna.svg');
		loadSVG($("#canvas02"), './svg/penguin.svg');
		loadSVG($("#canvas03"), './svg/laptop.svg');
		loadSVG($("#canvas04"), './svg/modem.svg');
		loadSVG($("#canvas05"), './svg/monitor.svg');
		loadSVG($("#canvas07"), './svg/Subtes-2008.svg');

		// ejemplo de svg inicialmente borrado
		deleteImage($("#div07"));
		
		restoring = false;
		// recarga de estado desde la cookie
		restoreOrder();
		restoring = false;
		
		// dialogo que mostrara el svg en tamaño original en un nuevo layer
		$(function() {
			$("#dialogContainer").dialog({
				title : 'Some title',
				resizable : false,
				bgiframe : true,
				overlay : {
					opacity : 0.3,
					background : "white"
				},
				position : [ 0, 0 ],
				autoOpen : false,
				height : 'auto',
				width : 'auto',
				modal : true,
				close : function(event, ui) {
					$('#dialogDiv').svg('destroy');
				}
			});
		});
	});

	// Funcion que carga el svg
	function loadSVG(divObj, svgUrl) {
		divObj.svg({
			onLoad : function() {
				var svg = divObj.svg('get');
				svg.load(svgUrl, {
					addTo : true,
					changeSize : true,
					onLoad : function() {
						scale(divObj);
					}
				});
			}
		});
	}

	// Funcion que escala un svg cargado usando como destino svgThumbWidth y svgThumbHeight
	function scale(objCanvas) {
		var svg = objCanvas.svg('get');
		var g = $('g', svg.root())[0];
		svg._svg.width.baseVal.convertToSpecifiedUnits(5);
		svg._svg.height.baseVal.convertToSpecifiedUnits(5);
		var widthPX = svg._svg.width.baseVal.valueInSpecifiedUnits;
		var heightPX = svg._svg.height.baseVal.valueInSpecifiedUnits;
		var scalew = svgThumbWidth / widthPX;
		var scaleh = svgThumbHeigth / heightPX;
		var scale = 0;
		if (scalew < scaleh) {
			scale = scalew;
		} else {
			scale = scaleh;
		}
		g.setAttribute('transform', 'scale(' + scale + ')');
	}
</script>
</head>
<body>
	<div class="demo ui-widget ui-helper-clearfix">

		<!-- Inicio de la galeria -->
		<div id="gallery" class="gallery ui-helper-reset ui-helper-clearfix ui-droppable">
			
			<!-- Contenedor del svg -->
			<div class="ui-widget-content ui-corner-tr ui-draggable" id="div00">
				<h5 class="ui-widget-header">
					Floppy 
						<a href="#" title="Delete this image" class="ui-icon ui-icon-trash"></a>
						<a href="./svg/gfloppy.svg" title="Floppy" class="ui-icon ui-icon-zoomin"></a>
				</h5>
				<div style="width: 100px; height: 63px" id="canvas00" class="svgcanvas"></div>
			</div>

			<div class="ui-widget-content ui-corner-tr ui-draggable" id="div01">
				<h5 class="ui-widget-header">Antenna
					<a href="#" title="Delete this image" class="ui-icon ui-icon-trash"></a>
					<a href="./svg/antenna.svg" title="Antenna" class="ui-icon ui-icon-zoomin"></a>
				</h5>
				<div style="width: 100px; height: 63px" id="canvas01" class="svgcanvas"></div>
			</div>

			<div class="ui-widget-content ui-corner-tr ui-draggable" id="div02">
				<h5 class="ui-widget-header">Penguin
					<a href="#" title="Delete this image" class="ui-icon ui-icon-trash"></a>
					<a href="./svg/penguin.svg" title="Penguin" class="ui-icon ui-icon-zoomin"></a>
				</h5>
				<div style="width: 100px; height: 63px" id="canvas02" class="svgcanvas"></div>
			</div>

			<div class="ui-widget-content ui-corner-tr ui-draggable" id="div03">
				<h5 class="ui-widget-header">Laptop
					<a href="#" title="Delete this image" class="ui-icon ui-icon-trash"></a>
					<a href="./svg/laptop.svg" title="Laptop" class="ui-icon ui-icon-zoomin"></a>
				</h5>
				<div style="width: 100px; height: 63px" id="canvas03" class="svgcanvas"></div>
			</div>

			<div class="ui-widget-content ui-corner-tr ui-draggable" id="div04">
				<h5 class="ui-widget-header">Modem
					<a href="#" title="Delete this image" class="ui-icon ui-icon-trash"></a>
					<a href="./svg/modem.svg" title="Modem" class="ui-icon ui-icon-zoomin"></a>
				</h5>
				<div style="width: 100px; height: 63px" id="canvas04" class="svgcanvas"></div>
			</div>

			<div class="ui-widget-content ui-corner-tr ui-draggable" id="div05">
				<h5 class="ui-widget-header">Monitor
					<a href="#" title="Delete this image" class="ui-icon ui-icon-trash"></a>
					<a href="./svg/monitor.svg" title="Monitor" class="ui-icon ui-icon-zoomin"></a>
				</h5>
				<div style="width: 100px; height: 63px" id="canvas05" class="svgcanvas"></div>
			</div>

			<div class="ui-widget-content ui-corner-tr ui-draggable" id="div07">
				<h5 class="ui-widget-header">Subtes
					<a href="#" title="Delete this image" class="ui-icon ui-icon-trash"></a>
					<a href="./svg/Subtes-2008.svg" title="Subtes" class="ui-icon ui-icon-zoomin"></a>
				</h5>
				<div style="width: 100px; height: 63px" id="canvas07" class="svgcanvas"></div>
			</div>

		</div>

	</div>
	<!-- End demo -->

	<div id="trash" class="ui-widget-content ui-state-default ui-droppable">

	</div>

	<div class="demo-description">
		Los svg tienen que tener un tag	<g> agrupandolos, de lo contrario no pueden ser escalados.<br>
		Falta la aplicacion de la grafica. 
	</div>
	<!-- End demo-description -->


	<div id="dialogContainer" title="Basic dialog">
		<div id="dialogDiv"></div>
	</div>

</body>
</html>
